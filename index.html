<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ø¯ÛŒÙˆØ§Ø± Ø±ÙˆØ³ØªØ§ â€” Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„</title>
<style>
body {
    font-family: sans-serif;
    direction: rtl;
    background:#f2f2f2;
    margin:0;
    padding:0;
}
.container {
    width:90%;
    max-width:700px;
    margin:auto;
    padding:20px;
    background:white;
    border-radius:10px;
    box-shadow:0 0 10px rgba(0,0,0,0.1);
    margin-top:30px;
}
h1,h2 {
    text-align:center;
    color:#007bff;
}
input,textarea,button {
    width:100%;
    padding:10px;
    margin-bottom:10px;
    border-radius:6px;
    border:1px solid #aaa;
    font-size:16px;
}
button {
    background:#007bff;
    color:white;
    border:none;
    cursor:pointer;
}
button:hover {
    background:#005fcc;
}
.card {
    background:#eaf0ff;
    padding:12px;
    margin-bottom:12px;
    border-radius:7px;
    box-shadow:0 0 3px rgba(0,0,0,0.2);
}
.error {
    background:#ffe1e1;
    border:1px solid red;
    padding:10px;
    margin:10px 0;
}
.hidden {display:none;}
.action-btn {
    padding:5px 10px;
    margin:2px;
    border:none;
    border-radius:5px;
    cursor:pointer;
}
.edit-btn {background:#ffc107; color:#fff;}
.delete-btn {background:#dc3545; color:#fff;}
</style>
</head>
<body>

<!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ùˆ Ø«Ø¨Øª Ù†Ø§Ù… -->
<div class="container" id="pageAuth">
    <h1>ğŸŒ¾ Ø¯ÛŒÙˆØ§Ø± Ø±ÙˆØ³ØªØ§</h1>
    <div id="authBox">
        <button onclick="showAuth('login')">ÙˆØ±ÙˆØ¯</button>
        <button onclick="showAuth('register')">Ø«Ø¨Øª Ù†Ø§Ù…</button>
    </div>

    <div id="loginBox" class="hidden">
        <h2>ÙˆØ±ÙˆØ¯</h2>
        <input id="loginPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†">
        <input type="password" id="loginPass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <div id="loginErr" class="error hidden"></div>
        <button onclick="loginUser()">ÙˆØ±ÙˆØ¯</button>
        <button onclick="showAuth('auth')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <div id="registerBox" class="hidden">
        <h2>Ø«Ø¨Øª Ù†Ø§Ù…</h2>
        <input id="regName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
        <input id="regPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†">
        <input type="password" id="regPass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <div id="regErr" class="error hidden"></div>
        <button onclick="registerUser()">Ø´Ø±ÙˆØ¹</button>
        <button onclick="showAuth('auth')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>
</div>

<!-- ØµÙØ­Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ -->
<div class="container hidden" id="pageAds">
    <h2>ğŸ“¢ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</h2>
    <input id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù† ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" oninput="loadAds()">
    <div id="adsBox">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</div>
    <button onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    <hr>
    <h2>Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ Ø¬Ø¯ÛŒØ¯</h2>
    <input id="adTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¢Ú¯Ù‡ÛŒ">
    <textarea id="adDesc" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª"></textarea>
    <input id="adPrice" placeholder="Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)" oninput="formatPrice()">
    <div id="priceFormatted" style="color:#555;"></div>
    <input id="adPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³">
    <div id="adErr" class="error hidden"></div>
    <button onclick="submitAd()">Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</button>
</div>

<script>
// ======== API endpoint ========
const userEndpoint = 'https://crudcrud.com/api/30e7d4246d234e7ea7efff3107cd5328/users';
const adEndpoint = 'https://crudcrud.com/api/30e7d4246d234e7ea7efff3107cd5328/ads';

// ======== Ø§Ù„ÙØ§Ø¸ Ø±Ú©ÛŒÚ© ========
const badWords = ['Ú©Ù„Ù…Ù‡_Ø¨Ø¯1','Ú©Ù„Ù…Ù‡_Ø¨Ø¯2'];

// ======== Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ ========
let currentUser = null;

// ======== Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù… ÙˆØ±ÙˆØ¯ ÛŒØ§ Ø«Ø¨Øª Ù†Ø§Ù… ========
function showAuth(type){
    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('registerBox').classList.add('hidden');
    document.getElementById('loginErr').classList.add('hidden');
    document.getElementById('regErr').classList.add('hidden');
    if(type==='login') document.getElementById('loginBox').classList.remove('hidden');
    else if(type==='register') document.getElementById('registerBox').classList.remove('hidden');
    else document.getElementById('authBox').classList.remove('hidden');
}

// ======== Ø«Ø¨Øª Ù†Ø§Ù… ========
async function registerUser(){
    const name = document.getElementById('regName').value.trim();
    const phone = document.getElementById('regPhone').value.trim();
    const pass = document.getElementById('regPass').value.trim();
    const errBox = document.getElementById('regErr');

    if(!name || !phone || !pass){
        errBox.innerText = 'Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª';
        errBox.classList.remove('hidden');
        return;
    }

    const res = await fetch(userEndpoint);
    const users = await res.json();
    if(users.find(u=>u.phone===phone)){
        errBox.innerText = 'Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø¨Ù„Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡';
        errBox.classList.remove('hidden');
        return;
    }

    await fetch(userEndpoint,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({fullname:name, phone, password:pass})
    });

    alert('Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚ âœ”ï¸');
    showAuth('login');
}

// ======== ÙˆØ±ÙˆØ¯ ========
async function loginUser(){
    const phone = document.getElementById('loginPhone').value.trim();
    const pass = document.getElementById('loginPass').value.trim();
    const errBox = document.getElementById('loginErr');

    if(!phone || !pass){
        errBox.innerText = 'Ù‡Ø± Ø¯Ùˆ ÙÛŒÙ„Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª';
        errBox.classList.remove('hidden');
        return;
    }

    const res = await fetch(userEndpoint);
    const users = await res.json();
    const user = users.find(u=>u.phone===phone && u.password===pass);
    if(!user){
        errBox.innerText = 'Ø´Ù…Ø§Ø±Ù‡ ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ ÛŒØ§ Ø«Ø¨Øª Ù†Ø§Ù… Ù†Ø´Ø¯Ù‡';
        errBox.classList.remove('hidden');
        return;
    }

    currentUser = user;
    showPageAds();
}

// ======== Ø®Ø±ÙˆØ¬ ========
function logout(){
    currentUser = null;
    showAuth('auth');
}

// ======== Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ ========
function showPageAds(){
    document.getElementById('pageAuth').classList.add('hidden');
    document.getElementById('pageAds').classList.remove('hidden');
    loadAds();
}

// ======== Ù‚Ø§Ù„Ø¨â€ŒØ¨Ù†Ø¯ÛŒ Ù‚ÛŒÙ…Øª ========
function formatPrice(){
    const input = document.getElementById('adPrice');
    let val = input.value.replace(/\D/g,'');
    if(!val) {document.getElementById('priceFormatted').innerText=''; return;}
    let formatted = Number(val).toLocaleString('en-US');
    let farsiText = Number(val).toLocaleString('fa-IR');
    document.getElementById('priceFormatted').innerText = formatted+' ØªÙˆÙ…Ø§Ù† ('+farsiText+')';
    input.value = val;
}

// ======== Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù„ÙØ§Ø¸ Ø±Ú©ÛŒÚ© ========
function hasBadWords(text){
    const lower = text.toLowerCase();
    return badWords.some(word=>lower.includes(word));
}

// ======== Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ ========
async function submitAd(){
    const title = document.getElementById('adTitle').value.trim();
    const desc = document.getElementById('adDesc').value.trim();
    const price = document.getElementById('adPrice').value.trim();
    const phone = document.getElementById('adPhone').value.trim();
    const errBox = document.getElementById('adErr');

    errBox.classList.add('hidden');
    if(!title || !desc || !price || !phone){
        errBox.innerText = 'Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª';
        errBox.classList.remove('hidden');
        return;
    }
    if(hasBadWords(title) || hasBadWords(desc)){
        errBox.innerText = 'Ø§ÛŒÙ† Ú©Ù„Ù…Ø§Øª Ù…Ù…Ù†ÙˆØ¹ Ø§Ø³Øª';
        errBox.classList.remove('hidden');
        return;
    }

    await fetch(adEndpoint,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            title, desc, price:Number(price), phone, userId:currentUser._id, time: new Date().toISOString()
        })
    });

    document.getElementById('adTitle').value='';
    document.getElementById('adDesc').value='';
    document.getElementById('adPrice').value='';
    document.getElementById('priceFormatted').innerText='';
    document.getElementById('adPhone').value='';
    loadAds();
}

// ======== Ø¨Ø§Ø±Ú¯Ø²Ø§Ø±ÛŒ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ ========
async function loadAds(){
    const box = document.getElementById('adsBox');
    const search = document.getElementById('searchInput')?.value.trim().toLowerCase() || '';
    box.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...';
    const res = await fetch(adEndpoint);
    const ads = await res.json();
    box.innerHTML = '';
    if(ads.length===0){
        box.innerHTML='Ù‡ÛŒÚ† Ø¢Ú¯Ù‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.';
        return;
    }

    ads.slice().reverse().forEach(a=>{
        const date = a.time ? new Date(a.time).toLocaleString('fa-IR') : '';
        let priceFarsi = Number(a.price).toLocaleString('fa-IR')+' ØªÙˆÙ…Ø§Ù†';

        if(search && !a.title.toLowerCase().includes(search) && !a.phone.includes(search)){
            return;
        }

        box.innerHTML += `
        <div class="card">
            <b>${a.title}</b> â€” ${priceFarsi}<br>
            ${a.desc}<br>
            Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³: ${a.phone}<br>
            <small style="color:#555">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª: ${date}</small><br>
            ${a.userId===currentUser._id ? `
            <button class="action-btn edit-btn" onclick='editAd("${a._id}")'>ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button class="action-btn delete-btn" onclick='deleteAd("${a._id}")'>Ø­Ø°Ù</button>`:''}
        </div>`;
    });
}

// ======== Ø­Ø°Ù Ø¢Ú¯Ù‡ÛŒ ========
async function deleteAd(id){
    if(!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
    await fetch(`${adEndpoint}/${id}`, {method:'DELETE'});
    loadAds();
}

// ======== ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢Ú¯Ù‡ÛŒ ========
async function editAd(id){
    const res = await fetch(`${adEndpoint}/${id}`);
    const ad = await res.json();
    document.getElementById('adTitle').value = ad.title;
    document.getElementById('adDesc').value = ad.desc;
    document.getElementById('adPrice').value = ad.price;
    formatPrice();
    document.getElementById('adPhone').value = ad.phone;

    await fetch(`${adEndpoint}/${id}`, {method:'DELETE'});
}
</script>

</body>
</html>
