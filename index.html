<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ø¯ÛŒÙˆØ§Ø± Ø±ÙˆØ³ØªØ§</title>
<style>
body { font-family: Tahoma,sans-serif; direction: rtl; background:#f2f2f2; margin:0; padding:0; }
.container{ width:90%; max-width:700px; margin:auto; padding:20px; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2); margin-top:20px;}
h1,h2,h3{text-align:center;}
input, textarea{ width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #aaa; }
button{ padding:10px 15px; background:#007bff; border:none; color:white; border-radius:6px; cursor:pointer; margin-top:5px;}
button:hover{ background:#005fcc; }
.hidden{display:none;}
.error{ background:#ffe1e1; border:1px solid red; padding:10px; margin:10px 0;}
.card{ background:#fafafa; padding:12px; margin-bottom:12px; border-radius:7px; box-shadow:0 0 3px rgba(0,0,0,0.1);}
.priceDisplay{ color:green; font-weight:bold; margin-bottom:5px;}
.adButtons{ margin-top:5px; }
.adButtons button{ background:#28a745; margin-left:5px;}
.adButtons button.delete{ background:#dc3545; }
.adButtons button:hover{ opacity:0.85; }
</style>
</head>
<body>

<div class="container" id="pageAuth">
<h1>ğŸŒ¾ Ø¯ÛŒÙˆØ§Ø± Ø±ÙˆØ³ØªØ§</h1>
<button onclick="showAuth('register')">Ø«Ø¨Øª Ù†Ø§Ù…</button>
<button onclick="showAuth('login')">ÙˆØ±ÙˆØ¯</button>

<div id="registerForm" class="hidden">
<h3>Ø«Ø¨Øª Ù†Ø§Ù…</h3>
<input id="regFullname" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
<input id="regPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†">
<input id="regPassword" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
<div id="regError" class="error hidden"></div>
<button onclick="registerUser()">Ø´Ø±ÙˆØ¹</button>
</div>

<div id="loginForm" class="hidden">
<h3>ÙˆØ±ÙˆØ¯</h3>
<input id="logPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†">
<input id="logPassword" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
<div id="logError" class="error hidden"></div>
<button onclick="loginUser()">ÙˆØ±ÙˆØ¯</button>
</div>
</div>

<div class="container hidden" id="pageHome">
<h2>Ø³Ù„Ø§Ù… <span id="userName"></span></h2>
<button onclick="showPage('pageAdd')">â• Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</button>
<button onclick="showPage('pageList')">ğŸ“‹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</button>
<button onclick="logout()">Ø®Ø±ÙˆØ¬</button>
</div>

<div class="container hidden" id="pageAdd">
<h2>Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ ğŸ“</h2>
<input id="adTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¢Ú¯Ù‡ÛŒ">
<textarea id="adDesc" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª"></textarea>
<input id="adPrice" placeholder="Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)">
<div id="priceDisplay" class="priceDisplay"></div>
<input id="adPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³">
<div id="adError" class="error hidden"></div>
<button onclick="submitAd()">Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ</button>
<button onclick="showPage('pageHome')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
</div>

<div class="container hidden" id="pageList">
<h2>ğŸ“¢ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡</h2>
<div id="adsBox">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</div>
<br>
<button onclick="showPage('pageHome')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://kwkzrqywsttohdrfvnup.supabase.co';
const supabaseKey = 'sb_publishable_P4_QztgH0ihIioZ8B0kIiw_pt1GBRf4';
const supabase = createClient(supabaseUrl, supabaseKey);

let currentUser = null;

// ------------------- Navigation -------------------
function showPage(id){
  document.querySelectorAll('.container').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}
function showAuth(type){
  document.getElementById('registerForm').classList.add('hidden');
  document.getElementById('loginForm').classList.add('hidden');
  if(type==='register') document.getElementById('registerForm').classList.remove('hidden');
  else document.getElementById('loginForm').classList.remove('hidden');
}

// ------------------- Auth -------------------
async function registerUser(){
  const fullname = document.getElementById('regFullname').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  const password = document.getElementById('regPassword').value.trim();
  const err = document.getElementById('regError');

  if(!fullname || !phone || !password){
    err.textContent = 'Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª';
    err.classList.remove('hidden'); return;
  }

  const { data, error } = await supabase.from('users').insert([{fullname, phone, password}]).select();
  if(error){ err.textContent = 'Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø¨Ù„Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª'; err.classList.remove('hidden'); return; }

  currentUser = {id: data[0].id, fullname, phone};
  document.getElementById('userName').textContent = fullname;
  showPage('pageHome');
}

async function loginUser(){
  const phone = document.getElementById('logPhone').value.trim();
  const password = document.getElementById('logPassword').value.trim();
  const err = document.getElementById('logError');

  if(!phone || !password){ err.textContent = 'Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª'; err.classList.remove('hidden'); return; }

  const { data, error } = await supabase.from('users').select('*').eq('phone',phone).eq('password',password).limit(1);
  if(error || data.length===0){ err.textContent = 'Ø´Ù…Ø§Ø±Ù‡ ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª'; err.classList.remove('hidden'); return; }

  currentUser = {id: data[0].id, fullname:data[0].fullname, phone:data[0].phone};
  document.getElementById('userName').textContent = currentUser.fullname;
  showPage('pageHome');
}

function logout(){
  currentUser = null;
  showPage('pageAuth');
}

// ------------------- Price formatting -------------------
const adPrice = document.getElementById('adPrice');
const priceDisplay = document.getElementById('priceDisplay');
adPrice.addEventListener('input',()=>{
  let val = parseInt(adPrice.value.replace(/,/g,'')) || 0;
  priceDisplay.textContent = val.toLocaleString('fa') + ' ØªÙˆÙ…Ø§Ù†';
});

// ------------------- Bad word filter -------------------
const badWords = ['Ú©Ù„Ù…Ù‡_Ø±Ú©ÛŒÚ©1','Ú©Ù„Ù…Ù‡_Ø±Ú©ÛŒÚ©2','Ú©Ù„Ù…Ù‡_Ø±Ú©ÛŒÚ©3'];
function containsBadWords(text){
  text = text.toLowerCase();
  return badWords.some(word=>text.includes(word));
}

// ------------------- Submit ad -------------------
async function submitAd(){
  if(!currentUser){ alert('Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯'); return; }
  const title = document.getElementById('adTitle').value.trim();
  const desc = document.getElementById('adDesc').value.trim();
  const price = parseInt(document.getElementById('adPrice').value.replace(/,/g,''))||0;
  const phone = document.getElementById('adPhone').value.trim();
  const err = document.getElementById('adError');

  if(!title || !desc || !price || !phone){
    err.textContent = 'Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª';
    err.classList.remove('hidden'); return;
  }
  if(containsBadWords(title+desc)){
    err.textContent = 'Ù…ØªÙ† Ø¯Ø§Ø±Ø§ÛŒ Ø§Ù„ÙØ§Ø¸ Ø±Ú©ÛŒÚ© Ø§Ø³Øª';
    err.classList.remove('hidden'); return;
  }

  await supabase.from('ads').insert([{title, desc, price, phone, user_id: currentUser.id}]);
  alert('Ø¢Ú¯Ù‡ÛŒ Ø«Ø¨Øª Ø´Ø¯ âœ”ï¸');
  document.getElementById('adTitle').value='';
  document.getElementById('adDesc').value='';
  document.getElementById('adPrice').value='';
  document.getElementById('adPhone').value='';
  priceDisplay.textContent='';
  showPage('pageHome');
  loadAds();
}

// ------------------- Load ads with edit/delete -------------------
async function loadAds(){
  const box = document.getElementById('adsBox');
  const { data, error } = await supabase.from('ads').select('*').order('created_at',{ascending:false});
  if(error){ box.textContent='Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§'; return; }
  if(data.length===0){ box.textContent='Ù‡ÛŒÚ† Ø¢Ú¯Ù‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.'; return; }

  box.innerHTML = '';
  data.forEach(ad=>{
    let buttons = '';
    if(currentUser && ad.user_id === currentUser.id){
      buttons = `<div class="adButtons">
        <button onclick="editAd('${ad.id}','${ad.title}','${ad.desc}','${ad.price}','${ad.phone}')">ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="delete" onclick="deleteAd('${ad.id}')">Ø­Ø°Ù</button>
      </div>`;
    }

    box.innerHTML += `
      <div class="card">
        <b>${ad.title}</b> â€” ${ad.price.toLocaleString('fa')} ØªÙˆÙ…Ø§Ù†<br>
        ${ad.desc}<br>
        Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³: ${ad.phone}
        ${buttons}
      </div>`;
  });
}

// ------------------- Edit ad -------------------
function editAd(id,title,desc,price,phone){
  showPage('pageAdd');
  document.getElementById('adTitle').value = title;
  document.getElementById('adDesc').value = desc;
  document.getElementById('adPrice').value = price;
  document.getElementById('adPhone').value = phone;
  priceDisplay.textContent = price.toLocaleString('fa') + ' ØªÙˆÙ…Ø§Ù†';

  const btn = document.querySelector('#pageAdd button');
  btn.textContent = 'Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
  btn.onclick = async ()=>{
    const newTitle = document.getElementById('adTitle').value.trim();
    const newDesc = document.getElementById('adDesc').value.trim();
    const newPrice = parseInt(document.getElementById('adPrice').value.replace(/,/g,''))||0;
    const newPhone = document.getElementById('adPhone').value.trim();

    if(!newTitle || !newDesc || !newPrice || !newPhone){
      document.getElementById('adError').textContent='Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª';
      document.getElementById('adError').classList.remove('hidden'); return;
    }
    if(containsBadWords(newTitle+newDesc)){
      document.getElementById('adError').textContent='Ù…ØªÙ† Ø¯Ø§Ø±Ø§ÛŒ Ø§Ù„ÙØ§Ø¸ Ø±Ú©ÛŒÚ© Ø§Ø³Øª';
      document.getElementById('adError').classList.remove('hidden'); return;
    }

    await supabase.from('ads').update({title:newTitle,desc:newDesc,price:newPrice,phone:newPhone}).eq('id',id);
    alert('Ø¢Ú¯Ù‡ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯ âœ”ï¸');
    btn.textContent='Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ';
    btn.onclick = submitAd;
    document.getElementById('adTitle').value='';
    document.getElementById('adDesc').value='';
    document.getElementById('adPrice').value='';
    document.getElementById('adPhone').value='';
    priceDisplay.textContent='';
    showPage('pageHome');
    loadAds();
  }
}

// ------------------- Delete ad -------------------
async function deleteAd(id){
  if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')){
    await supabase.from('ads').delete().eq('id',id);
    alert('Ø¢Ú¯Ù‡ÛŒ Ø­Ø°Ù Ø´Ø¯ âœ”ï¸');
    loadAds();
  }
}

loadAds();
</script>

</body>
</html>
