<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ø¯ÛŒÙˆØ§Ø± Ø±ÙˆØ³ØªØ§</title>
<style>
/* Reset & Global */
body { font-family: Tahoma,sans-serif; direction: rtl; margin:0; padding:0; background:#f2f2f2; }
header { background:#007bff; color:#fff; text-align:center; padding:15px; font-size:22px; }
.container { width:90%; max-width:800px; margin:20px auto; background:#fff; border-radius:10px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.15);}
h1,h2,h3{text-align:center;}
input, textarea { width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #aaa; }
button { padding:10px 15px; border:none; border-radius:6px; cursor:pointer; background:#007bff; color:#fff; margin-top:5px; }
button:hover{ background:#005fcc; }
.hidden{ display:none; }
.error{ background:#ffe1e1; border:1px solid red; padding:10px; margin:10px 0; }
.card{ background:#fafafa; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.card h3{ margin:0; }
.card p{ margin:5px 0; }
.card .price{ color:green; font-weight:bold; margin-top:5px; }
.card .actions{ margin-top:10px; }
.card .actions button{ margin-left:5px; }
.card .actions button.delete{ background:#dc3545; }
.card .actions button:hover{ opacity:0.85; }
</style>
</head>
<body>

<header>ğŸŒ¾ Ø¯ÛŒÙˆØ§Ø± Ø±ÙˆØ³ØªØ§</header>

<!-- Auth -->
<div class="container" id="pageAuth">
<h2>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
<div id="authButtons">
<button id="showRegisterBtn">Ø«Ø¨Øª Ù†Ø§Ù…</button>
<button id="showLoginBtn">ÙˆØ±ÙˆØ¯</button>
</div>

<div id="registerForm" class="hidden">
<h3>Ø«Ø¨Øª Ù†Ø§Ù…</h3>
<input id="regFullname" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
<input id="regPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†">
<input id="regPassword" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
<div id="regError" class="error hidden"></div>
<button id="regStartBtn">Ø´Ø±ÙˆØ¹</button>
</div>

<div id="loginForm" class="hidden">
<h3>ÙˆØ±ÙˆØ¯</h3>
<input id="logPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†">
<input id="logPassword" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
<div id="logError" class="error hidden"></div>
<button id="logStartBtn">ÙˆØ±ÙˆØ¯</button>
</div>
</div>

<!-- Home -->
<div class="container hidden" id="pageHome">
<h2>Ø³Ù„Ø§Ù… <span id="userName"></span></h2>
<button id="addAdBtn">â• Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</button>
<button id="listAdBtn">ğŸ“‹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</button>
<button id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
</div>

<!-- Add Ad -->
<div class="container hidden" id="pageAdd">
<h2>Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ ğŸ“</h2>
<input id="adTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¢Ú¯Ù‡ÛŒ">
<textarea id="adDesc" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª"></textarea>
<input id="adPrice" placeholder="Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)">
<div id="priceDisplay" class="priceDisplay"></div>
<input id="adPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³">
<div id="adError" class="error hidden"></div>
<button id="adSubmitBtn">Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ</button>
<button id="adBackBtn">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
</div>

<!-- List Ads -->
<div class="container hidden" id="pageList">
<h2>ğŸ“¢ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡</h2>
<div id="adsBox">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</div>
<br>
<button id="listBackBtn">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
<script>
/////////////////////////
// Supabase Setup
/////////////////////////
const supabaseUrl = 'https://kwkzrqywsttohdrfvnup.supabase.co';
const supabaseKey = 'sb_publishable_P4_QztgH0ihIioZ8B0kIiw_pt1GBRf4';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

let currentUser = null;
const badWords = ['Ú©Ù„Ù…Ù‡_Ø±Ú©ÛŒÚ©1','Ú©Ù„Ù…Ù‡_Ø±Ú©ÛŒÚ©2','Ú©Ù„Ù…Ù‡_Ø±Ú©ÛŒÚ©3'];

// ---------------- Navigation ----------------
function showPage(id){
  document.querySelectorAll('.container').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

// ---------------- Utility Functions ----------------
function showError(el, msg){ el.textContent=msg; el.classList.remove('hidden'); }
function hideError(el){ el.classList.add('hidden'); }
function containsBadWords(text){ text=text.toLowerCase(); return badWords.some(w=>text.includes(w)); }
function formatPrice(num){ return Number(num).toLocaleString('fa')+' ØªÙˆÙ…Ø§Ù†'; }

// ---------------- Auth ----------------
async function registerUser(){
  const fullname = document.getElementById('regFullname').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  const password = document.getElementById('regPassword').value.trim();
  const err = document.getElementById('regError'); hideError(err);
  if(!fullname || !phone || !password){ showError(err,'Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª'); return; }
  const { data, error } = await supabaseClient.from('users').insert([{fullname,phone,password}]).select();
  if(error){ showError(err,'Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø¨Ù„Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡ ÛŒØ§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ Ø§Ø³Øª'); return; }
  currentUser={id:data[0].id, fullname, phone};
  document.getElementById('userName').textContent = fullname;
  showPage('pageHome'); loadAds();
}

async function loginUser(){
  const phone = document.getElementById('logPhone').value.trim();
  const password = document.getElementById('logPassword').value.trim();
  const err = document.getElementById('logError'); hideError(err);
  if(!phone || !password){ showError(err,'Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª'); return; }
  const { data, error } = await supabaseClient.from('users').select('*').eq('phone',phone).eq('password',password).limit(1);
  if(error || data.length===0){ showError(err,'Ø´Ù…Ø§Ø±Ù‡ ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ ÛŒØ§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯'); return; }
  currentUser={id:data[0].id, fullname:data[0].fullname, phone:data[0].phone};
  document.getElementById('userName').textContent = currentUser.fullname;
  showPage('pageHome'); loadAds();
}

// ---------------- Logout ----------------
function logoutUser(){ currentUser=null; showPage('pageAuth'); }

// ---------------- Ads ----------------
async function submitAd(editId=null){
  if(!currentUser){ alert('Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯'); return; }
  const title = document.getElementById('adTitle').value.trim();
  const desc = document.getElementById('adDesc').value.trim();
  const price = parseInt(document.getElementById('adPrice').value.replace(/,/g,'')) || 0;
  const phone = document.getElementById('adPhone').value.trim();
  const err = document.getElementById('adError'); hideError(err);
  if(!title || !desc || !price || !phone){ showError(err,'Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª'); return; }
  if(containsBadWords(title+desc)){ showError(err,'Ù…ØªÙ† Ø¯Ø§Ø±Ø§ÛŒ Ø§Ù„ÙØ§Ø¸ Ø±Ú©ÛŒÚ© Ø§Ø³Øª'); return; }
  if(editId){
    await supabaseClient.from('ads').update({title,desc,price,phone}).eq('id',editId);
    alert('Ø¢Ú¯Ù‡ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯ âœ”ï¸');
  } else {
    await supabaseClient.from('ads').insert([{title,desc,price,phone,user_id:currentUser.id}]);
    alert('Ø¢Ú¯Ù‡ÛŒ Ø«Ø¨Øª Ø´Ø¯ âœ”ï¸');
  }
  clearAdForm();
  showPage('pageHome'); loadAds();
}

function clearAdForm(){
  document.getElementById('adTitle').value='';
  document.getElementById('adDesc').value='';
  document.getElementById('adPrice').value='';
  document.getElementById('adPhone').value='';
  document.getElementById('priceDisplay').textContent='';
}

async function loadAds(){
  const box = document.getElementById('adsBox'); box.textContent='Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...';
  const { data, error } = await supabaseClient.from('ads').select('*').order('created_at',{ascending:false});
  if(error){ box.textContent='Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§'; return; }
  if(data.length===0){ box.textContent='Ù‡ÛŒÚ† Ø¢Ú¯Ù‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.'; return; }
  box.innerHTML='';
  data.forEach(ad=>{
    let buttons='';
    if(currentUser && ad.user_id===currentUser.id){
      buttons=`<div class="actions">
        <button onclick="editAd('${ad.id}','${ad.title}','${ad.desc}','${ad.price}','${ad.phone}')">ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="delete" onclick="deleteAd('${ad.id}')">Ø­Ø°Ù</button>
      </div>`;
    }
    box.innerHTML+=`<div class="card">
      <h3>${ad.title}</h3>
      <p>${ad.desc}</p>
      <p class="price">${formatPrice(ad.price)}</p>
      <p>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³: ${ad.phone}</p>
      ${buttons}
    </div>`;
  });
}

function editAd(id,title,desc,price,phone){
  showPage('pageAdd');
  document.getElementById('adTitle').value=title;
  document.getElementById('adDesc').value=desc;
  document.getElementById('adPrice').value=price;
  document.getElementById('adPhone').value=phone;
  document.getElementById('priceDisplay').textContent=formatPrice(price);
  const btn = document.getElementById('adSubmitBtn');
  btn.textContent='Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
  btn.onclick = ()=>submitAd(id);
}

async function deleteAd(id){
  if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ø§ÛŒÙ† Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')){
    await supabaseClient.from('ads').delete().eq('id',id);
    alert('Ø¢Ú¯Ù‡ÛŒ Ø­Ø°Ù Ø´Ø¯ âœ”ï¸'); loadAds();
  }
}

// ---------------- Event Listeners ----------------
document.getElementById('showRegisterBtn').onclick = ()=>{ showPage('pageAuth'); document.getElementById('registerForm').classList.remove('hidden'); };
document.getElementById('showLoginBtn').onclick = ()=>{ showPage('pageAuth'); document.getElementById('loginForm').classList.remove('hidden'); };
document.getElementById('regStartBtn').onclick = registerUser;
document.getElementById('logStartBtn').onclick = loginUser;
document.getElementById('logoutBtn').onclick = logoutUser;
document.getElementById('addAdBtn').onclick = ()=>showPage('pageAdd');
document.getElementById('listAdBtn').onclick = ()=>{ showPage('pageList'); loadAds(); };
document.getElementById('adBackBtn').onclick = ()=>showPage('pageHome');
document.getElementById('listBackBtn').onclick = ()=>showPage('pageHome');
document.getElementById('adPrice').addEventListener('input',()=>{
  let val = parseInt(document.getElementById('adPrice').value.replace(/,/g,''))||0;
  document.getElementById('priceDisplay').textContent = formatPrice(val);
});
/////////////////////////
// Initial
/////////////////////////
showPage('pageAuth');
</script>

</body>
  </html>
